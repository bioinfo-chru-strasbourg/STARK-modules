#########
# STARK #
#########
# Usage: docker-compose up



version: '3.9'


# NETWORKS
##########


networks:
  
  slurm_internal:
    driver: bridge
    driver_opts:
        com.docker.network.bridge.enable_ip_masquerade: 'true'
        #com.docker.network.bridge.enable_ipv6: 'true'
    internal: false
    #enable_ipv6: false
    ipam:
      config:
        #- subnet: "10.11.0.0/16"
        - subnet: "${SUBNET}.0.0/16"
        #- subnet: "${SUBNET6}:/64"

# networks:
  
#   slurm_internal:
#     external: 
#        name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_NETWORK}

  # stark_stark:
  #   external: 
  #     name: "stark_stark"



# VOLUMES
#########

#stark-module-common-submodule-slurm-volume-

volumes:
  stark-module-common-submodule-slurm-volume-main-root-home:
  stark-module-common-submodule-slurm-volume-main-home:
  stark-module-common-submodule-slurm-volume-main-etc-ssh:
  stark-module-common-submodule-slurm-volume-main-etc-slurm:
  stark-module-common-submodule-slurm-volume-main-slurmctld:
  stark-module-common-submodule-slurm-volume-main-mail:
  
  stark-module-common-submodule-slurm-volume-main-src:
  stark-module-common-submodule-slurm-volume-main-container-shared:
  stark-module-common-submodule-slurm-volume-main-munge:
  stark-module-common-submodule-slurm-volume-main-mysql:
  # slurmdbd
  stark-module-common-submodule-slurm-volume-slurmdbd-tmp:
  stark-module-common-submodule-slurm-volume-slurmdbd-run:
  stark-module-common-submodule-slurm-volume-slurmdbd-run-lock:
  stark-module-common-submodule-slurm-volume-slurmdbd-journal:
  # mgmtnode
  stark-module-common-submodule-slurm-volume-mgmtnode-tmp:
  stark-module-common-submodule-slurm-volume-mgmtnode-run:
  stark-module-common-submodule-slurm-volume-mgmtnode-run-lock:
  stark-module-common-submodule-slurm-volume-mgmtnode-journal:
  # login
  stark-module-common-submodule-slurm-volume-login-tmp:
  stark-module-common-submodule-slurm-volume-login-run:
  stark-module-common-submodule-slurm-volume-login-run-lock:
  stark-module-common-submodule-slurm-volume-login-journal:
  # node00
  stark-module-common-submodule-slurm-volume-node00-tmp:
  stark-module-common-submodule-slurm-volume-node00-run:
  stark-module-common-submodule-slurm-volume-node00-run-lock:
  stark-module-common-submodule-slurm-volume-node00-journal:
  # rest
  stark-module-common-submodule-slurm-volume-rest-tmp:
  stark-module-common-submodule-slurm-volume-rest-run:
  stark-module-common-submodule-slurm-volume-rest-run-lock:
  stark-module-common-submodule-slurm-volume-rest-journal:
  # Config
  stark-module-common-submodule-slurm-volume-config-cluster-cfg:
    driver: local
    driver_opts:
       o: bind
       type: none
       device: ${CLUSTER_CONFIG_HOST_FOLDER}
  stark-module-common-submodule-slurm-volume-config-auth:
    driver: local
    driver_opts:
       o: bind
       type: none
       device: ${CLUSTER_CONFIG_HOST_FOLDER}
  # Service
  stark-module-common-submodule-slurm-volume-service-slurm:
    driver: local
    driver_opts:
       o: bind
       type: none
       device: ${CLUSTER_SERVICE_HOST_FOLDER}


# SERVICES
##########

services:


  stark-module-common-submodule-slurm-service-db:

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-sql_server:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    build:
      context: ./sql_server
      args:
        SUBNET: "${SUBNET}" #"10.11"
        #SUBNET6: "${SUBNET6}:"
      network: host

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-db

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_USER=slurm
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=slurm_acct_db
      - SUBNET=${SUBNET}
      #- SUBNET6="${SUBNET6}:"

    volumes:
      # System
      - /dev/log:/dev/log
      # Main
      - stark-module-common-submodule-slurm-volume-main-mysql:/var/lib/mysql

    hostname: db

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    networks:
      slurm_internal:
        ipv4_address: "${SUBNET}.1.3"
        #ipv6_address: "${SUBNET6}:1:3"
      #stark_stark:

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "mysqlcheck --all-databases || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6



  stark-module-common-submodule-slurm-service-slurmdbd:

    build:
      context: ./scaleout
      args:
        # DOCKER_FROM: almalinux # almalinux
        # SLURM_RELEASE: master # master
        DOCKER_FROM: almalinux:8.7 # almalinux
        SLURM_RELEASE: slurm-22.05 # master
        SUBNET: "${SUBNET}"
        #SUBNET6: "${SUBNET6}:"
        CACHE_DESTROYER: "1667128123"
      network: host

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-scaleout:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-slurmdbd

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET}"

    hostname: slurmdbd

    networks:
      slurm_internal:
        ipv4_address: "${SUBNET}.1.2"
        #ipv6_address: "${SUBNET6}:1:2"
      #stark_stark:

    volumes:
      # System
      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /sys/:/sys/:ro
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      #- /sys/fs/fuse/:/sys/fs/fuse/
      - /var/run/docker.sock:/var/run/docker.sock
      # Main
      - stark-module-common-submodule-slurm-volume-main-root-home:/root
      - stark-module-common-submodule-slurm-volume-main-etc-slurm:/etc/slurm
      - stark-module-common-submodule-slurm-volume-main-mail:/var/spool/mail/
      - stark-module-common-submodule-slurm-volume-main-src:/usr/local/src/
      # Service
      - stark-module-common-submodule-slurm-volume-slurmdbd-tmp:/tmp
      - stark-module-common-submodule-slurm-volume-slurmdbd-run:/run
      - stark-module-common-submodule-slurm-volume-slurmdbd-run-lock:/run/lock
      - stark-module-common-submodule-slurm-volume-slurmdbd-journal:/var/lib/journal
      # Config
      - stark-module-common-submodule-slurm-volume-config-cluster-cfg:${CLUSTER_CONFIG_INNER_FOLDER}

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      stark-module-common-submodule-slurm-service-db:
        condition: service_started

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "sacctmgr list stats || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6


  stark-module-common-submodule-slurm-service-mgmtnode:

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-scaleout:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-mgmtnode

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET6}:"
      - container=docker
      - REST_URL=rest

    hostname: mgmtnode

    networks:
      slurm_internal:
        ipv4_address: ${SUBNET}.1.1
        #ipv6_address: ${SUBNET6}:1:1
      #stark_stark:

    volumes:
      # System
      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /sys/:/sys/:ro
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      #- /sys/fs/fuse/:/sys/fs/fuse/
      - /var/run/docker.sock:/var/run/docker.sock
      # Main
      - stark-module-common-submodule-slurm-volume-main-root-home:/root
      - stark-module-common-submodule-slurm-volume-main-home:/home/
      - stark-module-common-submodule-slurm-volume-main-slurmctld:/var/spool/slurm
      - stark-module-common-submodule-slurm-volume-main-etc-ssh:/etc/ssh
      - stark-module-common-submodule-slurm-volume-main-etc-slurm:/etc/slurm
      - stark-module-common-submodule-slurm-volume-main-mail:/var/spool/mail/
      - stark-module-common-submodule-slurm-volume-main-src:/usr/local/src/
      - stark-module-common-submodule-slurm-volume-main-munge:/etc/munge
      # Service
      - stark-module-common-submodule-slurm-volume-mgmtnode-tmp:/tmp
      - stark-module-common-submodule-slurm-volume-mgmtnode-run:/run
      - stark-module-common-submodule-slurm-volume-mgmtnode-run-lock:/run/lock
      - stark-module-common-submodule-slurm-volume-mgmtnode-journal:/var/lib/journal
      # Config
      - stark-module-common-submodule-slurm-volume-config-auth:${CLUSTER_AUTH_INNER_FOLDER}
      - stark-module-common-submodule-slurm-volume-config-cluster-cfg:${CLUSTER_CONFIG_INNER_FOLDER}
      # Service
      - stark-module-common-submodule-slurm-volume-service-slurm:${CLUSTER_SERVICE_INNER_FOLDER}

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      stark-module-common-submodule-slurm-service-slurmdbd:
        condition: service_started
      # stark-module-common-submodule-slurm-service-node00:
      #   condition: service_started

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "sacctmgr list stats || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6


  stark-module-common-submodule-slurm-service-login:

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-scaleout:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-login

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET6}:"
      - container=docker

    hostname: login

    networks:
      slurm_internal:
        ipv4_address: ${SUBNET}.1.5
        #ipv6_address: ${SUBNET6}:1:5
      #stark_stark:

    volumes:
      # System
      - /dev/log:/dev/log
      #- /dev/fuse:/dev/fuse:rw
      - /etc/localtime:/etc/localtime:ro
      - /sys/:/sys/:ro
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      #- /sys/fs/fuse/:/sys/fs/fuse/
      - /var/run/docker.sock:/var/run/docker.sock
      # Main
      - stark-module-common-submodule-slurm-volume-main-root-home:/root
      - stark-module-common-submodule-slurm-volume-main-etc-ssh:/etc/ssh
      - stark-module-common-submodule-slurm-volume-main-etc-slurm:/etc/slurm
      - stark-module-common-submodule-slurm-volume-main-home:/home/
      - stark-module-common-submodule-slurm-volume-main-slurmctld:/var/spool/slurm
      - stark-module-common-submodule-slurm-volume-main-mail:/var/spool/mail/
      - stark-module-common-submodule-slurm-volume-main-src:/usr/local/src/
      - stark-module-common-submodule-slurm-volume-main-container-shared:/srv/containers
      # Service
      - stark-module-common-submodule-slurm-volume-login-tmp:/tmp
      - stark-module-common-submodule-slurm-volume-login-run:/run
      - stark-module-common-submodule-slurm-volume-login-run-lock:/run/lock
      - stark-module-common-submodule-slurm-volume-login-journal:/var/lib/journal
      # Config
      - stark-module-common-submodule-slurm-volume-config-cluster-cfg:${CLUSTER_CONFIG_INNER_FOLDER}

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "sacctmgr list stats || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6


  stark-module-common-submodule-slurm-service-node00:

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-scaleout:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-node00

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET6}:"
      - NODE_NAME=${NODE00_NAME}
      - NODE_IP4=${NODE00_IP4}
      #- NODE_IP6=${NODE00_IP6}
      - container=docker

    hostname: node00

    networks:
      slurm_internal:
        ipv4_address: ${NODE00_IP4}
        #ipv6_address: ${NODE00_IP6}
      #stark_stark:

    volumes:
      # System
      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /sys/:/sys/:ro
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      #- /sys/fs/fuse/:/sys/fs/fuse/
      - /var/run/docker.sock:/var/run/docker.sock
      # Main
      - stark-module-common-submodule-slurm-volume-main-root-home:/root
      - stark-module-common-submodule-slurm-volume-main-etc-ssh:/etc/ssh
      - stark-module-common-submodule-slurm-volume-main-etc-slurm:/etc/slurm
      - stark-module-common-submodule-slurm-volume-main-home:/home/
      - stark-module-common-submodule-slurm-volume-main-mail:/var/spool/mail/
      - stark-module-common-submodule-slurm-volume-main-src:/usr/local/src/
      - stark-module-common-submodule-slurm-volume-main-container-shared:/srv/containers
      # Service
      - stark-module-common-submodule-slurm-volume-node00-tmp:/tmp
      - stark-module-common-submodule-slurm-volume-node00-run:/run
      - stark-module-common-submodule-slurm-volume-node00-run-lock:/run/lock
      - stark-module-common-submodule-slurm-volume-node00-journal:/var/lib/journal
      # Config
      - stark-module-common-submodule-slurm-volume-config-cluster-cfg:${CLUSTER_CONFIG_INNER_FOLDER}

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      stark-module-common-submodule-slurm-service-mgmtnode:
        condition: service_started
      stark-module-common-submodule-slurm-service-slurmdbd:
        condition: service_started

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "sacctmgr list stats || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6


  stark-module-common-submodule-slurm-service-openondemand:

    build:
      context: ./openondemand
      network: host

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-openondemand

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-openondemand

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET6}:"
      - DEFAULT_SSHHOST=login

    volumes:
      # System
      - /dev/log:/dev/log
      # Main
      - stark-module-common-submodule-slurm-volume-main-etc-ssh:/etc/shared-ssh
      - stark-module-common-submodule-slurm-volume-main-home:/home/

    networks:
      slurm_internal:
        ipv4_address: ${SUBNET}.1.21
        #ipv6_address: ${SUBNET6}:1:21
      #stark_stark:

    depends_on:
      stark-module-common-submodule-slurm-service-login:
        condition: service_started

    ports:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_OPENONDEMAND_PORT_PUBLISHED}:80 #8081:80
      #- 8081:80 #8081:80

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    healthcheck:
      test: "curl -f http://0.0.0.0:80 || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6



  stark-module-common-submodule-slurm-service-rest:

    hostname: rest

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-scaleout:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    networks:
      slurm_internal:
        ipv4_address: ${SUBNET}.1.6
        #ipv6_address: ${SUBNET6}:1:6
      #stark_stark:

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-rest
    
    environment:
      - SUBNET=${SUBNET}

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    volumes:
      # System
      - /dev/log:/dev/log
      - /etc/localtime:/etc/localtime:ro
      - /sys/:/sys/:ro
      - /sys/fs/cgroup/:/sys/fs/cgroup/:ro
      #- /sys/fs/fuse/:/sys/fs/fuse/
      - /var/run/docker.sock:/var/run/docker.sock
      # Main
      - stark-module-common-submodule-slurm-volume-main-etc-ssh:/etc/ssh
      - stark-module-common-submodule-slurm-volume-main-etc-slurm:/etc/slurm
      # Service
      - stark-module-common-submodule-slurm-volume-rest-tmp:/tmp
      - stark-module-common-submodule-slurm-volume-rest-run:/run
      - stark-module-common-submodule-slurm-volume-rest-run-lock:/run/lock
      - stark-module-common-submodule-slurm-volume-rest-journal:/var/lib/journal
      # Config
      - stark-module-common-submodule-slurm-volume-config-cluster-cfg:${CLUSTER_CONFIG_INNER_FOLDER}

    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    depends_on:
      stark-module-common-submodule-slurm-service-mgmtnode:
        condition: service_started

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "pgrep slurmrestd || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6


  stark-module-common-submodule-slurm-service-proxy:

    build:
      context: ./proxy
      network: host

    image: ${DOCKER_STARK_SERVICE_IMAGE_REGISTRY}${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-proxy:${DOCKER_STARK_MODULE_SUBMODULE_RELEASE}

    container_name: ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX}-proxy

    env_file:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PREFIX_ENV_FILE}

    environment:
      - SUBNET="${SUBNET}"
      #- SUBNET6="${SUBNET6}:"
      - container=docker

    hostname: proxy

    command: ["bash", "-c", "nginx & php-fpm8 -F"]

    networks:
      slurm_internal:
        ipv4_address: ${SUBNET}.1.7
        #ipv6_address: ${SUBNET6}:1:7
      #stark_stark:

    volumes:
      # System
      - /dev/log:/dev/log
      # Config
      - stark-module-common-submodule-slurm-volume-config-auth:${CLUSTER_AUTH_INNER_FOLDER}
      # Service
      - stark-module-common-submodule-slurm-volume-service-slurm:${CLUSTER_SERVICE_INNER_FOLDER}
      
    tty: true

    logging:
      driver: local

    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - MKNOD
      - SYS_NICE
      - SYS_RESOURCE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    ports:
      - ${DOCKER_STARK_MODULE_SUBMODULE_SERVICE_PROXY_PORT_PUBLISHED}:8080 # 8080:8080
      #- 8080:8080 # 8080:8080

    depends_on:
      stark-module-common-submodule-slurm-service-rest:
        condition: service_started

    extra_hosts:
      - "db:${SUBNET}.1.3"
      #- "db:${SUBNET6}:1:3"
      - "slurmdbd:${SUBNET}.1.2"
      #- "slurmdbd:${SUBNET6}:1:2"
      - "mgmtnode:${SUBNET}.1.1"
      #- "mgmtnode:${SUBNET6}:1:1"
      - "login:${SUBNET}.1.5"
      #- "login:${SUBNET6}:1:5"
      - "rest:${SUBNET}.1.6"
      #- "rest:${SUBNET6}:1:6"
      - "proxy:${SUBNET}.1.7"
      #- "proxy:${SUBNET6}:1:7"
      - "openondemand:${SUBNET}.1.21"
      #- "openondemand:${SUBNET6}:1:21"
      - "node00:${SUBNET}.5.0"

    healthcheck:
      test: "nginx -t || exit 1"
      interval: 10s
      timeout: 10s
      retries: 6

